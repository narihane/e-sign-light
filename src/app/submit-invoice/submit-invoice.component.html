<div class="card card-register">
  <form
    class="form"
    [formGroup]="invoiceForm"
    (ngSubmit)="onInvoiceAdd()"
    autocomplete="off"
  >
    <div class="card-body">
      <div formArrayName="fixed">
        <h3>Choose Receiver Type</h3>
        <div class="row">
          <mat-radio-group
            class="example-radio-group"
            formControlName="receiverType"
            [(ngModel)]="receiverType"
            aria-label="Select an option"
          >
            <mat-radio-button class="example-radio-button" value="person"
              >Person
            </mat-radio-button>
            <mat-radio-button class="example-radio-button" value="business"
              >Business</mat-radio-button
            >
            <mat-radio-button class="example-radio-button" value="foreigner"
              >Foreigner</mat-radio-button
            >
          </mat-radio-group>
        </div>
        <ng-container *ngIf="receiverType === 'person'">
          <h3>Person Contact Information</h3>
          <div class="row">
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                    <i class="fas fa-user"></i>
                  </div>
                </div>
                <input
                  type="text"
                  placeholder="Client Name"
                  class="form-control"
                  id="name"
                  name="name"
                  required
                  formControlName="client_name"
                />
              </div>
            </div>
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                    <i class="fas fa-mobile-alt"></i>
                  </div>
                </div>
                <input
                  type="text"
                  placeholder="Client Phone Number"
                  class="form-control"
                  id="number"
                  name="number"
                  required
                  formControlName="client_phone"
                />
              </div>
            </div>
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                    <i class="far fa-envelope"></i>
                  </div>
                </div>
                <input
                  type="text"
                  placeholder="Client Email"
                  class="form-control"
                  id="email"
                  name="email"
                  required
                  formControlName="client_email"
                />
              </div>
            </div>
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                    <i class="far fa-address-card"></i>
                  </div>
                </div>
                <input
                  type="text"
                  placeholder="Client ID"
                  class="form-control"
                  id="id"
                  name="id"
                  formControlName="client_id"
                  totalPrice
                  [class.invalid]="
                    (invoiceForm.get('fixed')?.get('client_id')?.touched ||
                      invoiceForm.get('fixed')?.get('client_id')?.dirty) &&
                    invoiceForm.get('fixed')?.get('client_id')?.invalid &&
                    isSubmitted
                  "
                />
                <span
                  class="invalid-feedback"
                  *ngIf="
                    (invoiceForm.get('fixed')?.get('client_id')?.touched ||
                      invoiceForm.get('fixed')?.get('client_id')?.dirty) &&
                    invoiceForm.get('fixed')?.get('client_id')?.invalid &&
                    isSubmitted
                  "
                >
                  <!-- *ngIf="(invoiceForm.get('fixed')?.get('client_id')?.touched ||
                      invoiceForm.get('fixed')?.get('client_id')?.dirty) &&
                      invoiceForm.get('fixed')?.get('client_id')?.invalid">  -->
                  Client ID must be filled
                </span>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <!-- <div class="input-group"> -->
              <label for="exampleFormControlSelect3">Payment Type</label>
              <select
                class="form-control"
                formControlName="payment_type"
                id="exampleFormControlSelect3"
              >
                <option style="color: black">Cash</option>
                <option style="color: black">Visa</option>
              </select>
              <!-- </div> -->
            </div>
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <label for="branchDD">Branch</label>
              <select
                class="form-control"
                formControlName="branch"
                id="branchDD"
              >
                <option style="color: black">Korba</option>
                <option style="color: black">Tagamoaa</option>
              </select>
            </div>
          </div>
        </ng-container>
        <ng-container *ngIf="receiverType === 'business'">
          <h3>Business Contact Information</h3>
          <div class="row">
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                    <i class="fas fa-user"></i>
                  </div>
                </div>
                <input
                  type="text"
                  placeholder="Client Name"
                  class="form-control"
                  id="name"
                  name="name"
                  required
                  formControlName="client_name"
                />
              </div>
            </div>
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                    <i class="fas fa-mobile-alt"></i>
                  </div>
                </div>
                <input
                  type="text"
                  placeholder="Client Phone Number"
                  class="form-control"
                  id="number"
                  name="number"
                  required
                  formControlName="client_phone"
                />
              </div>
            </div>
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                    <i class="far fa-envelope"></i>
                  </div>
                </div>
                <input
                  type="text"
                  placeholder="Client Email"
                  class="form-control"
                  id="email"
                  name="email"
                  required
                  formControlName="client_email"
                />
              </div>
            </div>
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                    <i class="far fa-address-card"></i>
                  </div>
                </div>
                <input
                  type="text"
                  placeholder="Client ID"
                  class="form-control"
                  id="id"
                  name="id"
                  formControlName="client_id"
                  required
                />
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <!-- <div class="input-group"> -->
              <label for="exampleFormControlSelect3">Payment Type</label>
              <select
                class="form-control"
                formControlName="payment_type"
                id="exampleFormControlSelect3"
              >
                <option style="color: black">Cash</option>
                <option style="color: black">Visa</option>
              </select>
              <!-- </div> -->
            </div>
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <label for="branchDD">Branch</label>
              <select
                class="form-control"
                formControlName="branch"
                id="branchDD"
              >
                <option style="color: black">Korba</option>
                <option style="color: black">Tagamoaa</option>
              </select>
            </div>
          </div>
        </ng-container>
        <ng-container *ngIf="receiverType === 'foreigner'">
          <h3>Foreigner Contact Information</h3>
          <div class="row">
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                    <i class="fas fa-user"></i>
                  </div>
                </div>
                <input
                  type="text"
                  placeholder="Client Name"
                  class="form-control"
                  id="name"
                  name="name"
                  required
                  formControlName="client_name"
                />
              </div>
            </div>
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                    <i class="fas fa-mobile-alt"></i>
                  </div>
                </div>
                <input
                  type="text"
                  placeholder="Client Phone Number"
                  class="form-control"
                  id="number"
                  name="number"
                  required
                  formControlName="client_phone"
                />
              </div>
            </div>
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                    <i class="far fa-envelope"></i>
                  </div>
                </div>
                <input
                  type="text"
                  placeholder="Client Email"
                  class="form-control"
                  id="email"
                  name="email"
                  required
                  formControlName="client_email"
                />
              </div>
            </div>
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                    <i class="far fa-address-card"></i>
                  </div>
                </div>
                <input
                  type="text"
                  placeholder="Client ID"
                  class="form-control"
                  id="id"
                  name="id"
                  formControlName="client_id"
                  required
                />
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <!-- <div class="input-group"> -->
              <label for="exampleFormControlSelect3">Payment Type</label>
              <select
                class="form-control"
                formControlName="payment_type"
                id="exampleFormControlSelect3"
              >
                <option style="color: black">Cash</option>
                <option style="color: black">Visa</option>
              </select>
              <!-- </div> -->
            </div>
            <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
              <label for="branchDD">Branch</label>
              <select
                class="form-control"
                formControlName="branch"
                id="branchDD"
              >
                <option style="color: black">Korba</option>
                <option style="color: black">Tagamoaa</option>
              </select>
            </div>
          </div>
        </ng-container>
      </div>
      <br />
      <div formArrayName="items">
        <!-- <app-item-invoice
          [items]="items"
          [receiverType]="receiverType"
        ></app-item-invoice> -->

        <div *ngIf="receiverType">
          <h3>Invoice items</h3>
          <mat-table
            [dataSource]="dataSource"
            multiTemplateDataRows
            class="example-container mat-elevation-z8"
          >
            <!-- DeleteRow Column -->
            <ng-container matColumnDef="actions" [sticky]="true">
              <mat-header-cell *matHeaderCellDef> Delete Row </mat-header-cell>
              <mat-cell
                *matCellDef="let element; let i = index"
                [formGroup]="element"
              >
                <button
                  class="btn btn-link btn-fab btn-icon btn-round"
                  (click)="deleteItem(i)"
                >
                  <i class="far fa-trash-alt" style="color: crimson"></i>
                </button>
              </mat-cell>
            </ng-container>

            <!-- Category Column -->
            <ng-container matColumnDef="category">
              <mat-header-cell *matHeaderCellDef> Category </mat-header-cell>
              <mat-cell *matCellDef="let element" [formGroup]="element">
                <input
                  formControlName="category"
                  class="form-control"
                  list="datalistOptions"
                  id="exampleDataList"
                  placeholder="Type..."
                />
                <datalist id="datalistOptions">
                  <option
                    *ngFor="let category of categories"
                    [value]="category.codeNameSecondaryLang"
                  >
                    {{ category.codeNameSecondaryLang }}
                  </option>
                </datalist>
              </mat-cell>
            </ng-container>

            <!-- Weight Column -->
            <ng-container matColumnDef="weight">
              <mat-header-cell *matHeaderCellDef> Weight </mat-header-cell>
              <mat-cell *matCellDef="let element" [formGroup]="element">
                <input
                  type="text"
                  placeholder="Ex: 2.08"
                  required
                  formControlName="weight"
                  class="form-control"
                  id="weight"
                  name="weight"
                />
              </mat-cell>
            </ng-container>

            <!-- Quantity Column -->
            <ng-container matColumnDef="quantity">
              <mat-header-cell *matHeaderCellDef> Quantity </mat-header-cell>
              <mat-cell
                *matCellDef="let element; let i = dataIndex"
                [formGroup]="element"
              >
                <select
                  class="form-select"
                  formControlName="quantity"
                  id="exampleFormControlSelect1"
                  (change)="updateNetTotal(i)"
                >
                  <option style="color: black">1</option>
                  <option style="color: black">2</option>
                  <option style="color: black">3</option>
                  <option style="color: black">4</option>
                  <option style="color: black">5</option>
                  <option style="color: black">6</option>
                  <option style="color: black">7</option>
                  <option style="color: black">8</option>
                  <option style="color: black">9</option>
                  <option style="color: black">10</option>
                </select>
              </mat-cell>
            </ng-container>

            <!-- Unit Type Column -->
            <ng-container matColumnDef="unitType">
              <mat-header-cell *matHeaderCellDef> Unit </mat-header-cell>
              <mat-cell *matCellDef="let element" [formGroup]="element">
                <select class="form-select" formControlName="unitType">
                  <option value="gm">gm</option>
                </select>
              </mat-cell>
            </ng-container>

            <!-- Price column -->
            <ng-container matColumnDef="price">
              <mat-header-cell *matHeaderCellDef> Price </mat-header-cell>
              <mat-cell
                *matCellDef="let element; let i = dataIndex"
                [formGroup]="element"
              >
                <input
                  class="form-control"
                  currencyMask
                  placeholder="0.00 EGP"
                  required
                  formControlName="price"
                  value=""
                  mvndrMatCurrencyFormat
                  [allowNegative]="false"
                  [currencyCode]="'EGP'"
                  (change)="updateNetTotal(i)"
                />
              </mat-cell>
            </ng-container>

            <!-- Value diff column -->
            <ng-container matColumnDef="value_diff">
              <mat-header-cell *matHeaderCellDef>
                Value Difference
              </mat-header-cell>
              <mat-cell
                *matCellDef="let element; let i = index"
                [formGroup]="element"
              >
                <input
                  class="form-control"
                  currencyMask
                  placeholder="0.00 EGP"
                  required
                  formControlName="value_diff"
                  value=""
                  mvndrMatCurrencyFormat
                  [allowNegative]="false"
                  [currencyCode]="'EGP'"
                />
              </mat-cell>
            </ng-container>

            <!-- Total Taxable fees column -->
            <ng-container matColumnDef="total_taxable_fees">
              <mat-header-cell *matHeaderCellDef>
                Total Taxable Fees
              </mat-header-cell>
              <mat-cell
                *matCellDef="let element; let i = index"
                [formGroup]="element"
              >
                <input
                  class="form-control"
                  currencyMask
                  placeholder="0.00 EGP"
                  required
                  formControlName="total_taxable_fees"
                  value=""
                  mvndrMatCurrencyFormat
                  [allowNegative]="false"
                  [currencyCode]="'EGP'"
                />
              </mat-cell>
            </ng-container>

            <!-- Discount Column -->
            <ng-container matColumnDef="discount">
              <mat-header-cell *matHeaderCellDef> Discount </mat-header-cell>
              <mat-cell
                *matCellDef="let element; let i = dataIndex"
                [formGroup]="element"
              >
                <div class="Icon-inside">
                  <input
                    class="form-control"
                    placeholder="0"
                    required
                    formControlName="discount"
                    (change)="updateNetTotal(i)"
                  />
                  <i class="fa fa-percent"></i>
                </div>
              </mat-cell>
            </ng-container>

            <!-- Tax Column -->
            <ng-container matColumnDef="tax">
              <mat-header-cell *matHeaderCellDef> Tax </mat-header-cell>
              <mat-cell *matCellDef="let element; let i = dataIndex">
                <button
                  mat-icon-button
                  (click)="
                    expandedElement =
                      expandedElement === element ? null : element;
                    setCurrentInvoiceIdx(i)
                  "
                >
                  <mat-icon>add</mat-icon>
                </button>
              </mat-cell>
            </ng-container>

            <!-- Description Column -->
            <ng-container matColumnDef="description">
              <mat-header-cell *matHeaderCellDef> Description </mat-header-cell>
              <mat-cell *matCellDef="let element" [formGroup]="element">
                <textarea
                  class="form-control"
                  id="desc"
                  rows="1"
                  placeholder="Description"
                  required
                  formControlName="desc"
                ></textarea>
              </mat-cell>
            </ng-container>

            <!-- Net Total Column -->
            <ng-container matColumnDef="netTotal" stickyEnd>
              <mat-header-cell *matHeaderCellDef> Net Total </mat-header-cell>
              <mat-cell
                *matCellDef="let element; let i = index"
                [formGroup]="element"
              >
                <input
                  readonly
                  class="form-control"
                  placeholder="0.00"
                  required
                  formControlName="netTotal"
                  mvndrMatCurrencyFormat
                  [allowNegative]="false"
                  [currencyCode]="'EGP'"
                />
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="expandedDetail">
              <td
                mat-cell
                *matCellDef="let element; let idxInvoice = dataIndex"
                [formGroup]="element"
                [attr.colspan]="displayedColumns.length"
              >
                <div
                  [formGroup]="element"
                  class="example-element-detail"
                  [@detailExpand]="
                    element == expandedElement ? 'expanded' : 'collapsed'
                  "
                >
                  <!-- TAXES -->
                  <div>
                    <h2 style="text-align: center">Taxes</h2>
                    <div class="row">
                      <div
                        class="col-lg-3 col-md-3 offset-lg-0 offset-md-3"
                      ></div>
                      <div class="col-lg-5 col-md-6 offset-lg-0 offset-md-3">
                        <button mat-icon-button (click)="addTax(idxInvoice)">
                          <mat-icon>add</mat-icon> Add Tax
                        </button>
                      </div>
                      <div
                        class="col-lg-3 col-md-3 offset-lg-0 offset-md-3"
                      ></div>
                    </div>
                    <br /><br />
                    <div formArrayName="tax" autocomplete="off">
                      <div
                        *ngFor="
                          let i = index;
                          let attribute;
                          of: taxes(idxInvoice).controls
                        "
                      >
                        <div [formGroupName]="i">
                          <div class="row">
                            <!-- Tax Type -->
                            <div
                              class="col-lg-2 col-md-2 offset-lg-0 offset-md-3"
                            >
                              <mat-label>Tax Type</mat-label>
                              <mat-select
                                formControlName="type"
                                (change)="displaySubTax(idxInvoice, i)"
                              >
                                <mat-option
                                  *ngFor="let tax of taxArr"
                                  [value]="tax.Code"
                                >
                                  {{ tax.Code }}
                                </mat-option>
                              </mat-select>
                            </div>

                            <!-- Sub Tax Type -->
                            <div
                              class="col-lg-2 col-md-2 offset-lg-0 offset-md-3"
                            >
                              <mat-label>Sub Tax Type</mat-label>
                              <mat-select
                                formControlName="subType"
                                [disabled]="displaySubTax(idxInvoice, i)"
                              >
                                <mat-option
                                  *ngFor="
                                    let subTax of subTaxArray(idxInvoice, i)
                                  "
                                  [value]="subTax.Code"
                                >
                                  {{ subTax.Code }}
                                </mat-option>
                              </mat-select>
                            </div>

                            <!-- Tax amount -->
                            <div
                              class="col-lg-3 col-md-3 offset-lg-0 offset-md-3"
                            >
                              <input
                                class="form-control"
                                currencyMask
                                placeholder="0.00 EGP"
                                required
                                formControlName="amount"
                                [value]="displayedAmount(idxInvoice, i)"
                                (change)="calculateTaxAmount(idxInvoice, i)"
                                mvndrMatCurrencyFormat
                                [allowNegative]="false"
                                [currencyCode]="'EGP'"
                                [readonly]="!displayAmount(idxInvoice, i)"
                              />
                            </div>

                            <!-- Tax rate -->
                            <div
                              class="col-lg-3 col-md-3 offset-lg-0 offset-md-3"
                            >
                              <div class="input-group mb-3">
                                <input
                                  class="form-control"
                                  required
                                  formControlName="rate"
                                  value=""
                                  (change)="calculateTaxAmount(idxInvoice, i)"
                                  [readonly]="!displayRate(idxInvoice, i)"
                                />
                                <span class="input-group-text">%</span>
                              </div>
                            </div>
                            <div
                              class="col-lg-2 col-md-2 offset-lg-0 offset-md-3"
                            >
                              <button
                                class="btn btn-link btn-fab btn-icon btn-round"
                                (click)="deleteTax(i)"
                              >
                                <i
                                  class="far fa-trash-alt"
                                  style="color: crimson"
                                ></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </ng-container>

            <mat-header-row
              *matHeaderRowDef="displayedColumns; sticky: true"
            ></mat-header-row>
            <mat-row
              *matRowDef="let element; columns: displayedColumns"
              mat-row
              class="example-element-row"
              [class.example-expanded-row]="expandedElement === element"
            ></mat-row>
            <mat-row
              *matRowDef="let row; columns: ['expandedDetail']"
              class="example-detail-row"
            ></mat-row>
          </mat-table>
          <br />
          <div class="card-footer">
            <div class="row text-right">
              <!-- TODO:ADD CURRENCY -->
              <h3>Total Discount = {{ totalDiscount | currency: "EGP" }}</h3>
              <!-- <h3>Total Tax = {{ totalTax | currency: "EGP" }}</h3> -->
              <div id="accordion">
                <h5 class="mb-0">
                  <button
                    class="btn btn-link"
                    data-toggle="collapse"
                    data-target="#collapseOne"
                    aria-expanded="false"
                    aria-controls="collapseOne"
                    (click)="calculateTotalTax()"
                  >
                    Total Tax
                  </button>
                </h5>

                <div
                  id="collapseOne"
                  class="collapse"
                  aria-labelledby="headingOne"
                  data-parent="#accordion"
                >
                  <div class="card-body">
                    <table
                      mat-table
                      [dataSource]="dataTax"
                      class="mat-elevation-z8"
                    >
                      <ng-container matColumnDef="tax_type">
                        <th mat-header-cell *matHeaderCellDef>Tax Type</th>
                        <td mat-cell *matCellDef="let element">
                          {{ element[0] }}
                        </td>
                      </ng-container>

                      <!-- Name Column -->
                      <ng-container matColumnDef="amount">
                        <th mat-header-cell *matHeaderCellDef>Amount</th>
                        <td mat-cell *matCellDef="let element">
                          {{ element[1] }}
                        </td>
                      </ng-container>

                      <tr
                        mat-header-row
                        *matHeaderRowDef="displayColumnTax"
                      ></tr>
                      <tr
                        mat-row
                        *matRowDef="let row; columns: displayColumnTax"
                      ></tr>
                    </table>
                  </div>
                </div>
              </div>
              <h3>Net Total = {{ totalPrice | currency: "EGP" }}</h3>
            </div>
            <br />
            <button
              type="button"
              class="btn btn-primary btn-round btn-lg"
              (click)="addItem()"
            >
              Add Row
            </button>
            <button
              href="javascript:void(0)"
              [useExistingCss]="true"
              type="submit"
              printSectionId="myFormPrint"
              ngxPrint
              class="btn btn-primary btn-round btn-lg"
              printTitle=""
            >
              Submit
            </button>
          </div>
        </div>
      </div>
    </div>
    <div id="myFormPrint" style="display: none">
      <app-print-invoice [inputForm]="invoiceForm.value"></app-print-invoice>
    </div>
  </form>
</div>
